<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <link rel="manifest" href="manifest.json">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Deep Work Blackbox</title>
    <style>
        :root { --bg: #0d1117; --card: #161b22; --text: #c9d1d9; --accent: #58a6ff; --danger: #f85149; --paused: #484f58; }
        body { font-family: 'Pretendard', sans-serif; background: var(--bg); color: var(--text); display: flex; flex-direction: column; align-items: center; padding: 20px; min-height: 100vh; margin: 0; }
        .container { background: var(--card); padding: 2rem; border-radius: 20px; width: 90%; max-width: 450px; box-shadow: 0 15px 35px rgba(0,0,0,0.4); border: 1px solid #30363d; margin-top: 30px; }
        h2 { color: var(--accent); letter-spacing: 2px; text-align: center; margin-bottom: 25px; font-size: 1.5rem; }
        
        /* 숫자 클릭 가능하게 수정 */
        #display { font-size: 4.5rem; font-weight: 800; margin: 20px 0; text-align: center; font-variant-numeric: tabular-nums; cursor: pointer; transition: 0.2s; user-select: none; }
        #display.paused { color: var(--paused); opacity: 0.6; }
        #display:hover { transform: scale(1.05); }

        .mode-area { background: #0d1117; padding: 20px; border-radius: 12px; margin-bottom: 20px; display: flex; flex-direction: column; align-items: center; gap: 15px; border: 1px solid #30363d; }
        .radio-group { display: flex; gap: 30px; font-weight: bold; }
        .radio-group label { cursor: pointer; display: flex; align-items: center; gap: 8px; }
        .timer-inputs { display: none; align-items: center; gap: 10px; padding-top: 10px; border-top: 1px dashed #30363d; width: 100%; justify-content: center; }
        .timer-inputs.show { display: flex; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
        
        .task-input-style { background: #0d1117; border: 1px solid #30363d; color: white; padding: 15px; border-radius: 10px; width: 100%; box-sizing: border-box; margin-bottom: 20px; font-size: 1rem; outline: none; }
        input[type="number"] { background: #21262d; border: 1px solid #30363d; color: var(--accent); padding: 10px; border-radius: 8px; width: 70px; text-align: center; font-size: 1.1rem; font-weight: bold; outline: none; }
        
        .btns { display: flex; gap: 12px; }
        button { flex: 1; padding: 16px; border-radius: 12px; border: none; font-weight: bold; cursor: pointer; font-size: 1rem; transition: 0.2s; }
        #startBtn { background: var(--accent); color: white; } 
        #stopBtn { background: var(--danger); color: white; display: none; } 
        
        .timeline-header { display: flex; justify-content: space-between; align-items: center; margin-top: 30px; margin-bottom: 10px; width: 100%; }
        .header-btns { display: flex; gap: 5px; }
        .small-btn { background: #30363d; color: var(--text); padding: 4px 8px; font-size: 0.7rem; border-radius: 4px; cursor: pointer; border: none; }
        .small-btn.danger { color: var(--danger); }
        
        #logContainer { max-height: 400px; overflow-y: auto; width: 100%; padding-right: 5px; }
        .date-section { margin-top: 20px; border-top: 1px solid #30363d; padding-top: 10px; }
        .date-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .date-text { font-size: 0.85rem; font-weight: bold; color: var(--accent); }
        
        .log-item { background: #21262d; padding: 10px; margin-bottom: 8px; border-radius: 8px; border-left: 3px solid #444; position: relative; }
        /* 수정 가능한 텍스트 스타일 */
        .log-time-info { font-size: 0.75rem; color: #8b949e; margin-bottom: 4px; cursor: pointer; border-bottom: 1px dashed transparent; display: inline-block; }
        .log-time-info:hover { border-bottom: 1px dashed #8b949e; }
        .edit-info-input { background: #0d1117; border: 1px solid var(--accent); color: white; font-size: 0.75rem; padding: 2px 4px; border-radius: 4px; width: 80%; outline: none; }
        
        .log-editable-task { background: transparent; border: none; color: white; width: 85%; font-size: 0.9rem; outline: none; }
        .del-btn { position: absolute; right: 8px; top: 50%; transform: translateY(-50%); color: #666; cursor: pointer; font-size: 1rem; background: none; border: none; }
    </style>
</head>
<body>
    <div class="container">
        <h2>DEEP WORK BLACKBOX</h2>
        <div class="mode-area">
            <div class="radio-group">
                <label><input type="radio" name="mode" value="sw" checked onclick="toggleMode()"> 스톱워치</label>
                <label><input type="radio" name="mode" value="tm" onclick="toggleMode()"> 타이머</label>
            </div>
            <div id="timerSetting" class="timer-inputs">
                <input type="number" id="minInput" value="0" min="0" max="1440" oninput="syncTimerDisplay()"> 분
                <input type="number" id="secInput" value="0" min="0" max="59" oninput="syncTimerDisplay()"> 초
            </div>
        </div>
        <input type="text" id="taskInput" class="task-input-style" placeholder="오늘의 몰입 목표는?">
        <div id="display" onclick="togglePause()">00:00:00</div>
        <div class="btns">
            <button id="startBtn">몰입 시작</button>
            <button id="stopBtn">기록 후 종료</button>
        </div>
        <div class="timeline-header">
            <span style="font-size: 0.8rem; opacity: 0.6;">타임라인 히스토리</span>
            <div class="header-btns">
                <button id="copyAllBtn" class="small-btn">전체 복사</button>
                <button id="deleteAllBtn" class="small-btn danger">전체 삭제</button>
            </div>
        </div>
        <div id="logContainer"></div>
    </div>

<script>
    let timerInterval, totalSeconds = 0, initialSetSeconds = 0, isTimerMode = false, isRunning = false, isPaused = false;
    const display = document.getElementById('display'), startBtn = document.getElementById('startBtn'), stopBtn = document.getElementById('stopBtn');
    const logContainer = document.getElementById('logContainer');

    window.onload = () => { renderAllLogs(); };

    // 일시정지 토글 함수
    function togglePause() {
        if (!isRunning) return; 
        isPaused = !isPaused;
        display.classList.toggle('paused', isPaused);
    }

    function toggleMode() {
        const mode = document.querySelector('input[name="mode"]:checked').value;
        isTimerMode = (mode === 'tm');
        document.getElementById('timerSetting').classList.toggle('show', isTimerMode);
        isTimerMode ? syncTimerDisplay() : updateDisplay(0);
    }
    
    function syncTimerDisplay() { if(!isRunning && isTimerMode) updateDisplay((parseInt(document.getElementById('minInput').value)||0)*60 + (parseInt(document.getElementById('secInput').value)||0)); }
    
    function updateDisplay(s) {
        const h = Math.floor(s/3600), m = Math.floor((s%3600)/60), sec = s%60;
        display.innerText = `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(sec).padStart(2,'0')}`;
    }

    startBtn.onclick = () => {
        if(isTimerMode) {
            totalSeconds = (parseInt(document.getElementById('minInput').value)||0)*60 + (parseInt(document.getElementById('secInput').value)||0);
            initialSetSeconds = totalSeconds; if(totalSeconds <= 0) return;
        } else totalSeconds = 0;
        
        isRunning = true; isPaused = false;
        display.classList.remove('paused');
        startBtn.style.display = 'none'; stopBtn.style.display = 'block';
        
        timerInterval = setInterval(() => {
            if (isPaused) return; // 일시정지 중이면 카운트 안 함

            if(isTimerMode) { 
                totalSeconds--; 
                if(totalSeconds<=0) { clearInterval(timerInterval); finishWork(true); } 
            } else totalSeconds++;
            
            updateDisplay(totalSeconds);
        }, 1000);
    };

    stopBtn.onclick = () => finishWork(false);

    function finishWork(isAuto) {
        clearInterval(timerInterval); isRunning = false; isPaused = false;
        display.classList.remove('paused');

        const now = new Date();
        const days = ['일','월','화','수','목','금','토'];
        const duration = isTimerMode ? formatTime(isAuto ? initialSetSeconds : initialSetSeconds - totalSeconds) : formatTime(totalSeconds);
        const timeStr = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

        const logData = {
            id: Date.now(),
            date: `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')}`,
            day: days[now.getDay()],
            time: timeStr,
            duration: duration,
            info: `소요: ${duration} / [${timeStr}]`, // 소요 시간이 앞으로 오게 구성
            task: document.getElementById('taskInput').value || "이름 없는 몰입"
        };
        
        const logs = JSON.parse(localStorage.getItem('deepwork_logs') || '[]');
        logs.unshift(logData); localStorage.setItem('deepwork_logs', JSON.stringify(logs));
        renderAllLogs();
        
        startBtn.style.display = 'block'; stopBtn.style.display = 'none';
        document.getElementById('taskInput').value = ''; updateDisplay(0); toggleMode();
    }

    function formatTime(s) {
        const h = Math.floor(s/3600), m = Math.floor((s%3600)/60), sec = s%60;
        return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(sec).padStart(2,'0')}`;
    }

    function renderAllLogs() {
        logContainer.innerHTML = '';
        const logs = JSON.parse(localStorage.getItem('deepwork_logs') || '[]');
        if (logs.length === 0) {
            logContainer.innerHTML = '<div style="text-align:center; padding:20px; font-size:0.8rem; opacity:0.4;">기록이 없습니다.</div>';
            return;
        }
        
        const grouped = logs.reduce((acc, log) => {
            if(!acc[log.date]) acc[log.date] = { day: log.day, items: [] };
            acc[log.date].items.push(log);
            return acc;
        }, {});

        Object.keys(grouped).forEach(date => {
            const section = document.createElement('div');
            section.className = 'date-section';
            section.innerHTML = `
                <div class="date-header">
                    <span class="date-text">${date} (${grouped[date].day})</span>
                    <button class="small-btn" onclick="copyDateLogs('${date}')">복사</button>
                </div>
            `;
            grouped[date].items.forEach(log => {
                const item = document.createElement('div');
                item.className = 'log-item';
                // 더블 클릭으로 시간 정보 수정 가능
                item.innerHTML = `
                    <div class="log-time-info" ondblclick="editLogInfo(${log.id}, this)">${log.info}</div>
                    <input type="text" class="log-editable-task" value="${log.task}" onchange="updateLogTask(${log.id}, this.value)">
                    <button class="del-btn" onclick="deleteLog(${log.id})">×</button>
                `;
                section.appendChild(item);
            });
            logContainer.appendChild(section);
        });
    }

    // 시간 정보(소요/시각) 더블클릭 수정 함수
    window.editLogInfo = (id, el) => {
        const currentVal = el.innerText;
        const input = document.createElement('input');
        input.className = 'edit-info-input';
        input.value = currentVal;
        
        input.onblur = () => {
            saveLogInfo(id, input.value);
            renderAllLogs();
        };
        input.onkeydown = (e) => {
            if (e.key === 'Enter') input.blur();
        };
        
        el.innerHTML = '';
        el.appendChild(input);
        input.focus();
    };

    function saveLogInfo(id, newVal) {
        let logs = JSON.parse(localStorage.getItem('deepwork_logs') || '[]');
        const log = logs.find(l => l.id === id);
        if(log) { log.info = newVal; localStorage.setItem('deepwork_logs', JSON.stringify(logs)); }
    }

    window.updateLogTask = (id, val) => {
        let logs = JSON.parse(localStorage.getItem('deepwork_logs') || '[]');
        const log = logs.find(l => l.id === id);
        if(log) { log.task = val; localStorage.setItem('deepwork_logs', JSON.stringify(logs)); }
    };

    window.deleteLog = (id) => {
        if(confirm('이 기록을 삭제할까요?')) {
            let logs = JSON.parse(localStorage.getItem('deepwork_logs') || '[]');
            localStorage.setItem('deepwork_logs', JSON.stringify(logs.filter(l => l.id !== id)));
            renderAllLogs();
        }
    };

    document.getElementById('deleteAllBtn').onclick = () => {
        if(confirm('⚠️ 모든 히스토리를 영구히 삭제할까요?')) {
            localStorage.removeItem('deepwork_logs');
            renderAllLogs();
        }
    };

    window.copyDateLogs = (date) => {
        const logs = JSON.parse(localStorage.getItem('deepwork_logs') || '[]').filter(l => l.date === date);
        const text = `[${date} 기록]\n` + logs.map(l => `${l.info} / ${l.task}`).join('\n');
        navigator.clipboard.writeText(text).then(() => alert(`${date} 기록 복사 완료!`));
    };

    document.getElementById('copyAllBtn').onclick = () => {
        const logs = JSON.parse(localStorage.getItem('deepwork_logs') || '[]');
        if (logs.length === 0) return;
        const text = "[전체 몰입 기록]\n" + logs.map(l => `${l.date}(${l.day}) ${l.info} ${l.task}`).join('\n');
        navigator.clipboard.writeText(text).then(() => alert("전체 기록 복사 완료!"));
    };
</script>
</body>
</html>
